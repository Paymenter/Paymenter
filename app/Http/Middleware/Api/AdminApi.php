<?php

namespace App\Http\Middleware\Api;

use App\Models\ApiKey;
use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;
use Illuminate\Support\Facades\Cache;

class AdminApi
{
    private const SHREK_MOVIE_SCRIPT = "Once upon a time there was a lovely princess. But she had an enchantment upon her of a fearful sort, which could only be broken by Loves first kiss. She was locked away in a castle guarded by a terrible fire breathing dragon. Many brave knights had attempted to free her from this dreadful prison, but none prevailed. She waited in the dragons keep in the highest room of the tallest tower for her true love and true loves first kiss. Like thats ever going to happen. What a loony. Shrek Beware Stay out I think hes in here. All right. Lets get it! Hold on. Do you know what that thing can do to you? Yeah. Hell groan into your bones for his brains. Well actually that would be a giant. Now Ogres, huh, they are much worse. Theyll make a soup from your freshly peeled skin. Theyll chew your livers, squeeze the jelly from your eyes. Actually, its quite good on toast. Back, back beast, back! I warned you! Right. This is the part, where you run away. Yeah! And stay out. Wanted. Fairytale creatures. Right, this one is full. Take it away. Give me that. Your fine days are over. -25 pieces of silver for the witch. Next. -Come on. Sit down there! And be quiet! This cage is so small. You wouldnt turn me in. Ill never be stubborn again. I can change. Please, give me another chance. Oh, shut up! Next. What do we got? This little wooden puppet. Im not a puppet, Im a real boy. Five shillings for the possessed toy. Take it away. No! Please, dont let them do it! Next. What do you got? Well, Ive got a talking donkey! Right. Well thats good for ten schillings, if you can prove it. Oh, go ahead fella. Well? Hes just a li..., just a little nervous. Hes really quite a chatterbox. You boneheaded donkey! Thats it. I have heard enough. Guards! No, no, he talks, he does! I can talk. I love to talk. Ive talked to... Get her out of my sight! -No, no, I swear! Hey, I can fly. -He can fly! -He can fly! He can talk! -Thats right, fool! Now Im a flying, talking donkey! You might have seen house fly, maybe even a superfly. But I bet you aint never seen a donkey fly! Seize him! Get him! This way! Hurry! You there. Ogre. -I. By the order of lord Farquaad. I am authorized to place you both under arrest. And transport you to designated resettlement facility. Oh really? You and what army? Can I say something to you? Listen, you were really, really something, back there. Incredible. Are you talking to... ...me? Yes, I was talking to you. Can I just tell you that you were really great back there with those guards. They thought that was all over there. And then you showed up and BAM. There was tripping on over themselves like babes in the woods. That really made me feel good to see that. Oh, thats great. Really. Man, its good to be free. Now, why dont you go celebrate your freedom with your own friends? But I... I dont have any friends. And Im not going out there by myself. Hey wait a minute. I have a great idea... Ill stick with you. You and me in green fighting machine. Together well scare the spin if anybody crosses us. Oh, a, that was really scary. Maybe you dont mine me saying. If that dont work, your breath will certainly do the job done, cause... you definitively need some tic-tac or something, cause your breath stinks! Man youve ??? my note! Just like the time... ...and then I ate some rotten berries. Man I had some strong gases leaking out of my but that day. Why are you following me? Ill tell you why. Cause Im all alone, there is no one here, beside me. My problems have all gone. Theres no one to derive me. But you got to have free ... -Stop singing! Well, its no wonder, you dont have any friends. Wow! Only a true friend would be that truly honest. Listen! Little donkey. Take a look at me! What am I? A... ...really tall? No! Im an Ogre. You know, grab your torch and pitchforks. Doesnt that bother you? Nope. Really? -Really really. Oh? Man, I like you. Whats your name? A..., Shrek. Shrek?! But do you know, what I like about you, Shrek? Youve got that kind of: I dont care what nobody thinks of me thing. I like that, I respect that, Shrek. Youre all right. Uh, look at that. Who would wanna live in a place like that? That would be my home. Oh, it is lovely. Just beautiful. You know youre quite a decorator. Its amazing what you did with such a modest budget. I like that boulder. That is a nice boulder. I guess, you dont entertain much, do you? I like my privacy. You know I do to. Thats another thing, we have in common. Like I hate it when you got somebody in your face. You try to give them a hint and they wont leave. And then theres that big occurred silence, you know? Can I stay with you? -What? Can I stay with you, please. Of course! -Really? No. -Please! I dont want to go back there. You dont how is like to be concerned like a freak. Well..., maybe you do. But thats why we have to stick together! You got to let me stay! Please! Please! OK, OK. -But one night only. -Huh, thank you! A, what are you do... No! This is going to be fun. We can stay up late, swap the manly stories. And in the morning... Im making waffles. Where do I sleep? Outside! Oh, a, I guess thats cool. You know, I dont know you and you dont know me... ... so I guess, outside is best for me. Here I go. Good night. I do like that half door. Im a donkey all alone outside. Sit by myself outside, I guess. Im all alone, theres no one here beside me. -I thought, I told you to stay outside. -I am outside. Well James. This is far from the farm, but what choice do we have? Its not... What a lovely bed. -Got you! I found some cheese. Awful stuff. -Is that you Gordon? -How did you know? Enough! What are you doing in my house? Oh, no, no, no... Death prods off the table! Where would we supposed to put her. The beds taken. What? I live in a swamp. Ive put up signs. Im a terrifying Ogre! What do I have to do, to get a little privacy? Oh, no! No, no! What are you doing in my swamp? All right, get out of here. All of you. Move it! Come on, lets go. And hurry up, hurry up. No, no, not there. Not there! Hey dont look at me. I didnt invite them. Oh gosh, no one invited us. -What? We were forced to come here. -By who? Lord Farquaad. He ??? All right. Who knows where this Farquaad guy is? Oh I do. I know where he is. Does anyone else know where to find him? -Anyone at all? -Me. -Anyone? Oh pick me, I know! Me, me. Ok, fine. Attention all fairy tale things! Do not get comfortable. Your welcome is officially warned up. In fact. Im gonna see this guy Farquaad right now and get all off my land and back where you came from. You. Youre coming with me. All right. Thats what I like to hear, man. Shrek and Donkey, two stubborn friends off on a world and big city adventure. I love it. Im on road again. Sing with me Shrek! Im on road again... What did I say about singing? -Can I whistle? -No. -Well, can I hummer? -All right. Thats enough. Hes ready to talk. Run, run, run as fast as you can, you cant catch me. Im the gingerbread man. You monster. Im not a monster here. You are. You and the rest of that fairytale trash, poisoning my perfect world. -Now tell me! Where are the others? -Eat me. Ive tried to be fair to you, creatures. Now my patience has reached its end! -Tell me! Or Ill... -No, no, not the buttons. Not gumdrop buttons. All right! Whos hiding them? Ok, Ill tell you. -Do you know the muffin-man? -The muffin-man? -The muffin-man. -Yes, I know the muffin-man. Who lives on Proully lane? -Well, shes married to the muffin-man. -The muffin-man! -The muffin-man! -Shes married to the muffin-man. My lord! We found it. Well then, what are you waiting for? Bring it in. Magic mirror. Dont tell him anything! Evening. Mirror, mirror on the wall. Is this not the most perfect kingdom of them all? Well, technically, youre not a king. A..., felonious. -You were saying. -What I mean is a... ...youre not a king, yet. But you can become one. All you have to do, is marry a princess. Go on. So, just sit back and relax my lord, because its time for you to meet todays eligible bachelorettes. And here they are. Bachelorette number one is a mentally abused shading from a kingdom far, far away. She likes sushi and hottubbing anytime. Her hobbies include cooking and cleaning for two evil sisters. Please welcome... Cinderella. Bachelorette number two is a kemp wearing girl from a land of fantasy. Although she lives with seven other man, she is not easy. Just kiss hers dead frozen lips and find out what a live wife she is. Come on. Give it up for... Show-white. And last but certainly not least. Bachelorette number three is a fire-breathing ????, dragon guarded castle, surrounded by a hot boiling lava. But dont let that cool you off. Shes a loaded pistol who likes Pina Coladas and getting cut in the rain. Yours for the rescuing, Princess Fiona. So will it be, bachelorette number one? Bachelorette number two? Or bachelorette number three? -Two... -Three! -Two! One. No, no, no. Three. Pick number three my lord. Ok, ok. Number three. Lord Farquaad. Youve chosen... princess Fiona. Shes nice. Fiona. Shes perfect. All I have to do is just find someone... But I probably should mention little thing that happens at night... -Ill do it! -Yes, but after sunset... Silence! I will make this princess Fiona my queen. And Duloc will finally have the perfect king! Captain! Assemble your finest man. Were going to have a tournament! Thats it, thats, right there, thats Duloc. Ive told you Ill find it. So. That must be lord Farquaads castle. Aha, thats the place. Do you think maybe hes compensating for something. Hey, hey wait up Shrek! -Hey, you! -No, no! Wait a second. Look, Im not gonna eat you. I just... Its quiet. Too quiet. Where is everybody? Hey look at this. Wow! -Lets do that again. -No. no. All right. Youre going the right way for smack bottom. Sorry about that. That champion should have the honor, no, no... ...the privilege to go forth and rescue the lovely princess Fiona from the fireing keep of the dragon. If for any reason the winner is unsuccessful, the first runner up will take his place. And so on, and so forth. Some of you may die, but its a sacrifice Im willing to make. Applause. Let the tournament begin. What is that? Ugh, its hideous. Oh, thats not very nice. Its just a donkey. Indeed. Knights! New plan. The one, who kills the Ogre, will be named champion. How about him. Oh, hey. Now, come on. Cant we just settle this over a pint? No? All right then. Come on. Hey Shrek! Let me, let me! The chair! Give him the chair! Thank you. Thank you, very much. Im here until Thursday. Try the wheel! Shall I give the order sir? No. I have a better idea. People of Duloc. I give you our champion! What? Congratulation, Ogre. Youve won the honor of embarking on a great and noble quest. Quest? Im already on a quest. A quest to get my swamp back! -Your swamp? -Yeah, my swamp! Where you dumped those fairytale creatures. Indeed. All right Ogre, Ill make you a deal. Go on this quest for me and Ill give you your swamp back. Exactly the way it was? Down to the last slime covered toast tool. -And the squatters? -As good as gone. What kind of quest? Ok, let me get this straight! We gonna go find the dragon and rescue a princess just so Farquaad will give you back the swamp, which you only dont have, cause he filled it with full of freaks on the first place. -Is that about right? -You know what? Maybe there is a good reason, donkeys shouldnt talk. I dont get it Shrek. Why didnt you just pull some old Ogre stuff on them? You know, ??? . Grab his bones to make you brave. You know the whole Ogre trick. Oh, you know what. Maybe I could have decapitated entire village and put their heads on plate. Got a knife, cut open their spleens and drink their fluids. Does that sound good to you? A, no, not really, no. For your information, there is a lot more to Ogres than people think. -Example. -Example? OK, A-a-m, Ogres are like onions. -They stink? -Yes, no. -O, they make you cry. -No. Oh, you leave them out on the sun and they get all brown and start ??? little wild hairs? No! Layers! Onions have layers. Ogres have layers. Onions have layers. You get it? We both have layers. O, you both have layers. You know not everybody likes onions. Cake! Everybody loves cakes. Cakes have layers. I dont care what everyone likes. Ogres are not like cakes. You know what else everyone likes? Paffe. Have you ever met a person and you say: Hey, lets get some paffe and they say I dont like paffe. Paffe is delicious. No! You tensed, irritating, miniature peace of barden. Ogres are like onions. End of story. Bye, bye. See you lather. Paffe is maybe the most delicious thing on the whole damn planet. You know I think Ive preferred your humming. Do you have a tissue or something, cause Im making a mess. Just the word paffe has made me start slimying Why, Shrek, did you do that? Man you got to warn somebody before you just crack one off. My mouth was opened and everything. Believe me donkey, if it was me, youd be dead. Its brimstone. We must be getting close. Yeah, right, brimstone. Dont be talking ??? brimstone. I know what I smell and ??? no brimstone. And they dont come of stone neither. Sure its big enough, but look at the location. Oh, Shrek, remember when you said that Ogres have layers? Oh, yeah. Well, I have a confession to make. Donkeys dont have layers. We wear ??? sleeves. Wait a second. Donkeys dont have sleeves. -You know what I mean. -Oh, you cant tell me youre afraid of highs. No, Im just a little uncomfortable of being on a rickety bridge over boiling lake of lava! Come on donkey, Im right here beside you. Ok? For emotional support. Well just hackle this thing together one little baby step after time. -Really? -Really really. Ok. That makes me feel so much better. Just keep moving and dont look down. Dont look down, dont look down. Shrek! Im looking down! I cant do this. Just let me off right now, please. -But youre already half way. -Yeah, but I know that half is safe. Ok, fine. I dont have time for this. You go back. Shrek, no, wait. Dont do that! Oh, Im sorry. Do what? -Oh. This? -Yes, that! Yes, yes. Do it. OK. -No, Shrek! -Im doing it. Im gonna die. Im gonna die. Shrek, Im gonna die. That will do Donkey, that will do. Cool. So where is this fire breathing pain in the neck anyway? Inside. Waiting for us to rescue her. I was talking about the dragon Shrek. -Are you afraid? -No, but shhhhh. Oh, good. Me neither. Because theres nothing wrong with being afraid. Heres a..., something responsible of the situation. Not to mention dangerous situation. And theres dragon that breathes fire. Im sure hes meaner than a cow or anything, but theyre scare. You know what I mean. Im sure hes heavier than a cow... Donkey. Two things. Ok? Shut, up. Now go over there and see if you can find any stairs. Stairs? I thought we were looking for the princess. The princess will be up the stairs in the highest room in the tallest tower. What makes you think shell be there? I read it in a book once. Cool. You handle the dragon, Ill handle the stairs. Oh, Ill find those stairs. Ill ???. Thats right. Those stairs wont know which way they go. The drafting stairs, ??? Dont mess with me. Im the stair master. Im master of the stairs. I wish I had a stair right here right here now, Id step all over it. Well, at least we know where the princess is. -But where is the... -Dragon! Donkey, look out! Got you. Oh, what large teeth you have. I mean, white sparkling teeth. You probably hear this all the time from your food, but you must bleach yourself, because that is one dashing smile you got there. And do I detect the hint of minty freshness? And you know what else? Youre a girl dragon. Oh, sure. I mean course youre a girl dragon, cause youre just ricking the feminine beauty out. Whats the matter with you? Do you have something in your eye? Man, Id really love to stay, but you know Im a asthmatic and I dont know if we would worked out. Youd be blowing smoke and stuff. Shrek! No, Shrek! Shrek! -Wake up! -What? Are you princess Fiona? I am. Awaiting a knight so bold as to rescue me. Oh, thats nice. Now lets go. But wait, sir knight. This be our first meeting. Should not be wonderful, romantic moment? Yeah. Sorry lady theres no time. Hey, what are you doing? You know, you should sweep me out of my feet. Out through the window and down the rope by to your valued steed. Youve had a lot of time to plan this, havent you? Uh-um. But we have to sing through this moment. You can residing of a poem to me. A ballad, a sonnet, a libretti. Or something. I dont think so. Well, can I at least know a name of my champion? Shrek. So, Shrek. I pray that you take this favor as a token of my gratitude. Thanks. -You didnt slay the dragon? -Its not my job to do this. Now, come on! But this isnt right. ??? Thats what all the other knights did. Yeah. Right before they burst in the flame. Thats not the point. Wait. Where are you going? Exit is over there. Well, I have to save my ass. What kind of knight are you? One of a kind. ...rush into a physical relationship. Im not that emotionally ready for commitment of a this magnitude. That was the word I was looking for. Magnitude. Hey, that is unwanted physical contact. Hey, what are you doing? Ok, ok, lets just back up a little and take this one step at the time. I mean, we really should get to know each other first, you know what am I saying. As friends, maybe even as ??? Hey dont do that. Thats my tail. Thats ma personal tail. And youre going to tear it off.... Oh, no. No! -It talks?! -Yeah. Its getting to shut up, thats a trick. Ok, you two. Head for the exit. Ill take care of the dragon. Ruuuuun! You did it. You rescued me. Amizing, youre wonderful. Youre a ... ...a little unorthodox I admit, but by deed is great and by heart is pure. Im entirely in your debt. And where would a brave knight be without his noble steed. I hope you heard that. She called me a noble steed. She thinks Im a steed. The battle is won. You may remove your helmet good sir knight. -Aah, no. -Why not? I have helmet hair. Please. I wouldst look upon the face of my rescuer. Oh, no, you wouldnt, dust. But, how will you kiss me? What? That wasnt in a job description. -Maybe its a perk? -No. Its destiny. You must know how it goes. A princess locked in a tower and besieged by a dragon is rescued by a brave knight. And then they share true loves first kiss. With Shrek? You think, wait... ...you think Shrek is your true love? Well, yes. You think that Shrek is your true love. What is so funny? Lets just say, Im not your type, ok? Of course you are. Youre my rescuer. Now, now remove your helmet. Look. I really dont think this is a good idea. -Just take off the helmet. -Im not going to. -Take it off! -No! -Now! -Ok, easy. As you command your highness. Youre an Ogre. Oh, you were expecting Prince Charming. Well, yes, actually. Oh no. This is all wrong. Youre not supposed to be an Ogre. Princess, I was sent to rescue you by lord Farquaad, ok? Hes the one, who wants to marry you. Well, then why didnt he come to rescue me? Good question. You should ask him that, when we get there. But I have to be rescued by my true love. Not by some Ogre and his pet. Well so much for noble steed. Look princess. Youre not making my job any easier. Well Im sorry, but your job is not my problem. You can tell lord Farquaad that if he wants to rescue me properly, Ill be waiting for him right here. Hey, Im no ones messenger boy, all right? -Im a delivery boy. -You wouldnt dare. -You coming donkey? -Put me down! Yeah, Im right behind you. Put me down or you will suffer the consequences. This is not dignified. Put me down. Ok, heres another question. Lets say that a woman digged you, but you dont really like her, that way. Now, how you let her down real easy, so her feelings arent hurt? But you dont get burned to a crisp neither. How do you do this? Just tell her, shes not your true love. Everyone knows it what happens when you find... Hey! The sooner we get to Duloc, the better. Oh, yeah. You gonna love it there princess. Its beautiful. And what of my groom to be, lord Farquaad. Whats he like? Well, let me put it this way, princess. Men of Farquaads stature are in short supply. Oh no, Shrek. There are those who think little of him. Stop it. Stop it, both of you. You know, youre just jealous that you can never measure up to a great ruler like lord Farquaad. Yeah. Well maybe youre right princess. But Id like you do that measuring when you see him tomorrow Tomorrow? It will take that long? -Shouldnt we stop to make camp? -No. That would take longer. We can keep going. But there are robbers in the woods. Whoa, time out Shrek. Camp is definitely something that sounds good. Hey. Come on. Im scarier than anything were gonna see in this forest. I need to find somewhere to camp, now! Hey, over here. Shrek, we can do better than that. Now, I dont think this is decent for princess. No, no, its perfect. It just needs a few homey touches. Homey touches? Like what? A door. Well, gentleman Ill be d..., good night. Do you want me to come in and read you a bedtime story, cause I will... I said good night! Shrek! What are you doing? I just..., you know... Oh, come on, I was just kidding. And that one, thats Throwback. The only Ogre to ever spit over three wheat fields. Right. Yeah. Hey, can you tell my future form these stars? Well, the stars dont tell the future, Donkey. They tell stories. Look. Theres Blodna, the Flatulent You can guess what he is famous for. All right. Now I know youre making this up. No. Look. There he is and theres the group of hunters running away from his stag. Man, there aint nothing, but a bunch of little dots. You know donkey, sometimes things are more than they appear. Forget it. Hey Shrek. What are you gonna do when we get our swamp back, anyway? -Our swamp? -You know. When were through rescuing the princess and all that stuff. We? Donkey, there is no we. Theres no our. Theres just me and my swamp. And the first thing Im gonna do, is build a ten foot wall around my land. You cut me deep Shrek, you cut me real deep just now. You know, what I think? I think this whole wall thing is just a way to keep somebody out. No, do you think? -Are you hiding something? -Never mind Donkey. Oh, this is another one of those onion things, isnt it? No. This is one of those drop it and leave it alone things. -Why dont you want to talk about it? -Why do you want to talk about it? -Oh, Why you block? -Im not blocking. -Oh yes you are. -Donkey, Im warning you. -Who are you trying to keep out? Just tell me that Shrek. Who? Everyone, ok? -Oh, now were getting somewhere. -Oh, for the love of pit. Hey, whats your problem Shrek? What do you got against the whole world anyway? Look. Im not the one with the problem, ok? Its the world that seems to have a problem with me. People take one look at me and go: AAA... Help! Run! A big stupid ugly Ogre. They judge me, before they even know me. Thats why Im better off alone. You know what? When we met, I didnt think youre just a big stupid, ugly Ogre. Yeah, I know. So, a... Are there any donkeys up there? Well, theres a Cabby. The small and annoying. Ok, ok. I see him, now. Big shining one, right there. That one, over there? Thats the moon. Again. Show me again. Mirror, mirror, show her to me. Show me the princess. Perfect. Yeah. You know I like like that. Oh come on baby... -Donkey. Wake up. -What? -Wake up. Morning. How do you like your eggs? -Good morning princess. -Whats all this about? You know, we kind of got of to a bad start yesterday and I wanted to make it up to you. I mean, after all, you did rescue me. Thanks. Well, eat up. Weve got a big day ahead of us. -Shrek! -What? Its a compliment. Better out than in I always say. But thats no way to behave in front of a princess. -Thanks. -Shes as nasty as you are. You know. Youre not exactly what Ive expected. Well, maybe you shouldnt judge people before you get to know them. Princess! What are you doing? ???mon shery, for I am your saviour. And I am rescuing you from this green...beast. Hey! Thats my princess. Go find your own. Please, monster. Cant you see Im a little busy here? Look, pal. I dont know who you think you are. Oh, of course. How rude that was. Please, let me introduce myself. Oh marry men! Man, that was annoying. Oh, you little... Shall we? ???all the forin??? Whoa, hold on, now. Where did that come from? -What? -That. Back there. That was amazing. Where did you learn that? Well, when one lives alone one has to learn these things in case theres a... There is an arrow in your butt. What? Oh, would you look at that. Oh, no... This is all my fault. Im so sorry. -Whats wrong? -Shreks hurt. -Shreks hurt? Shreks hurt! -Oh, no. Shreks going to die. -Donkey, Im ok. You cant do this to me Shrek. Im too young for you to die. Keep your legs elevated. Turn your head ???. -Does anyone know how to handle... -Donkey! Calm down. If you want to help Shrek, run into woods and find me a blue flower with red thorns. Blue flower, red thorns. Ok, Im on it. Blue flower, red thorns. Blue flower, red thorns. Dont die Shrek. And if you see a long tunnel, stay away from the light! -Donkey! -Oh, yeah. Right. Blue flower, red thorns. Blue flower, red thorns. -What are the flowers for? -For getting rid of the Donkey. Now, you hold still and Ill yank this thing out. -Hey! Easy with the yanking. -Im sorry, but it has to come out. No, no. Its tender. What youre doing here is the opposite... -Dont move. -Ok, look. Time out. -Would you... Ok. What do you propose we do? Blue flower, red thorns. Blue flower, red thorns. Blue flower, red thorns. This would be so much easier if I wasnt colorblind. Blue flower, red thorns. Blue flower, red thorns. Hold on, Shrek. Im coming! Not good. Ok, ok, I can lose it. Its just about it. Nothing happened. We were just a... Look if you want to be alone, all you had to do is ask, ok? Oh, come on. Thats the last thing on my mind. The princess here was just... Au! Hey, whats that? Is that... There it is, princess. -Your future awaits you. -Thats Duloc? Yeah. I know. Youll shrink things lord Farquaad is compensating for something, which I think needs, he has a I guess we better move on. Sure, but Shrek... -Im worried about Donkey. -What? I mean. Look at him. He doesnt look so good. -What are you talking about? Im fine. -Well, thats what they always say. And the next thing you know youre on your back. -Dead! -You know shes right. You look awful. -Do you want to sit down? -You know, Ill make you up some tea. Well, I wont say nothing, but Ive got this twinge in my neck. And if I turn my neck like this, look. Au, see? -Hes hungry. Ill find us some dinner. -Ill get the firewood. Hey, where are you going? Oh man, I cant feel my thumbs. I dont have any thumbs!!! I think I need a hug. This is good. This is really good. -What is this? -Wheat rat. -Rotisserie style. -No kidding. -Oh, this is delicious. -Well, they also great in stews. Now, I dont mean to brag, but I make a mean wheat rat stew. I guess Ill be dining a little different late tomorrow night. Maybe you can come visit me in the swamp sometime. Ill cook all kinds of stuff for you. Swamp toast, soup fish, eye tartar. You name it. Id like that. -Ah... , princess? -Yes, Shrek? Im a.... I was wondering. Are you... a... Are you gonna eat that? Man, isnt this romantic. Just look at that sunset. Sunset?! Oh, no. Its late. Its very late. -What? -Wait a minute. I see whats going on here. Youre afraid of the dark. Arent you? Yes, yes. Thats it. Thats, Im terrified. You know Ill better go inside. But dont feel bad, princess. I used to be afraid of the dark too. Until... Hey, no, wait. Im still afraid of the dark. -Good night. -Good night. Ahh. Now I really see whats going on here. Oh, what are you talking about. Hey I dont wanna even hear. Look, Im an animal and I got instincts. And I know that you two are digging on each other. I can feel it. Oh, youre crazy. Im just bringing her back to Farquaad. Oh, come on, Shrek. Wake up and smell the fairemones. Just go in there and tell her how you feel. Theres nothing to tell. Besides, even if I did tell her that... well you know. Im not saying that I do, cause I dont. Shes a princess and Im... ...an Ogre. Yeah, an Ogre. -Hey, where are you going? -To get more firewood. Princess. Princess Fiona? Princess, where are you? Princess? Its very spooky in here and are we playing little games. -No, no. -Help! Shrek! Shrek! -No. -Shrek! -Its ok. Its ok. -What did you do with the princess? -Donkey, shhh. Im the princess. -Its me, in this body. -Oh my god. You ate the princess. -Can you hear me? -Donkey! Listen, keep breathing. Ill get you out of there! Shrek! Shrek! Shrek! This is me. Princess? What happened to you? Youre a... different. -Im ugly, ok? -Yeah. Was it something that you ate? Cause I told Shrek those rats were a bad idea. -You are what you eat, I say. -No. Ive been this way as long as I can remember. What do you mean? Look, Ive never seen you like this before. It only happens when the sun goes down. By night one way, by day another. This shall be the norm until you find true loves first kiss. Then, take loves true form... -Oh, thats beautiful. I didnt know you wrote poetry. -Its the spell. When I was a little girl, a witch cast a spell on me. Every night I become this. This horrible ugly beast. I was placed in a tower to await the day when my true love would rescue me. Thats why I have to marry lord Farquaad tomorrow, before the sun sets and he sees me, like this? All right, all right. Calm down. Look, its not that bad. Youre not that ugly. Wait, wait, Ill not lie, you are ugly. But you only look like this at night. Shreks ugly 24/7. But Donkey, Im a princess. And this is not how a princess is meant to look. Princess. How about if you dont marry Farquaad? I have to. Only my true loves kiss can brake the spell. But you know, youre kind of an Ogre. And Shrek... Well youve got a lot in common. Shrek? Princess, I... How is it going first of all? Good? Good for me to. Im ok. I saw this flower and thought of you because its pretty. And, well, I dont really like it, but I thought you may like it, because youre pretty. But I like you anyway. A.... Im in trouble. Ok, here we go. Who could ever love a piece so hideous and ugly? Princess and ugly dont go together. Thats why I cant stay here with Shrek, but only chance to live happily ever after is to marry my true love. Dont you see, Donkey? Thats just how it has to be. Its the only way to break the spell. Well, at least youve got tell Shrek the truth. No, no. You cant breathe the word. No one must ever know. Whats the point of being unable to talk? You got to keep secrets. Promise you wont tell. Promise! You know, before this is over, Im going to need whole lot of serious therapies. All right, all right. I wont tell him. But you should. Look at my eye twitching. I tell him, I tell him not. I tell him. I tell him not. I tell him! Shrek! Shrek! Theres something I want ... Shrek. Are you all right? Perfect. Never been better. I... Theres something I have to tell you. You dont have to tell me anything, princess. I heard enough last night. -Youve heard what I said? -Every word. I thought youd understand? Oh, I understand! Like you said, who could love a hideous, ugly beast! -I thought that wouldnt matter to you. -Yeah, well, it does. Ah, right on time. Princess. I brought you a little something. What I missed? What I missed? -Princess Fiona. -As promised. Now hand it over. Very well, Ogre. The deed to your swamp. Cleared out as agreed. Take it and go. Before I change my mind. Forgive me princess for startling you, but you startled me. For Ive never seen such a radiant beauty before. -I am lord Farquaad. -Lord Farquaad? Oh, no, no... forgive me my lord for I was just saying short... farewell. Oh. That is so sweet. You dont have to raise good manners on the Ogre. -Its not like it has feelings. -No. Youre right. It doesnt. Princess Fiona, beautiful fair flawless Fiona, I ask your hand in marriage. Will you be the perfect bride for the perfect groom? Lord Farquaad, I accept. Nothing would make... Excellent! Ill start the plans for tomorrow we wedd... No! I mean I... Why wait? Lets get married today. Before sunset. Oh, anxious are we? Youre right. The sooner, the better. Theres so much to do. There is the camera, the cake, the band, the guests... Captain! Round up some guests. Farewell Ogre. Shrek, what are you doing? You let her get away. -Yeah, so what. -Shrek. Theres something about her that you dont know. -I talked to her last night. Shes... -Yeah I know you talked to her last night. Youre great pal, arent you? Now, if you two are such good friend, why didnt you follow her home? -Shrek. I want to go with you. -I told you, didnt I? Youre not coming home with me. I live alone. My swamp, me and nobody else! Understand? Nobody! Especially useless, pathetic, annoying, talking donkeys! -But. I thought... -Yeah. You know what? You thought wrong. Shrek. Donkey? What are you doing? I was thinking of all the people, you would recognize a wall when you see one. Well, yeah. But the wall supposed to go around my swamp. Not through it. It is around your half. See? Thats your half and this is my half. Oh, your half? Yes, my half. I helped rescue the princess. I did half the work. I get half the booty. Now hand me that big old rock, the one that looks like your head -Back off! -No. You back off! -This is my swamp. -Our swamp. -Let go, Donkey! -You let go! -Stubborn jackass. -Smelly Ogre. Fine! Hey, hey, come back here. Im not through with you, yet. -Well, Im through with you! -Well, you know. You were always me, me, me. Well, guess what? Now its my turn! So you just shut up and pay attention! You are mean to me, you insult me, you dont appreciate anything that I do! Youre always pushing me around or pushing me away. Oh, yeah? Well, if I treated you so bad, how come you came back? Because thats what friend do. They forgive each other! Oh, yeah. Youre right Donkey. I forgive you for stabbing me in the back! Youre so wrapped up in layers, onion boy. Youre afraid of your own feelings. -Go away. -See? There you are, doing it again. Just like you did it to Fiona. And all she ever do, was like you. Maybe even love you. Love me? She said I was ugly! A hideous creature. -I heard that you two were talking. -She wasnt talking about you. She was talking about... ...somebody else. She wasnt talking about me? Well then, who was she talking about? No way, Im not saying anything. You wont listen to me, right? Right? -Donkey. -No! Ok, look. Im sorry, all right? Im sorry. I guess I am just a big stupid, ugly Ogre. Can you forgive me? -Hey, thats the friends are for, right? -Right. -Friends? -Friends. So? What did Fiona said about me? Why are you asking me for? Why dont you just go ask her. The wedding! Well never make it in time! Never fear! For where there is a will, there is a way. And I have I way. Donkey? -I guess this is just my act of magnetism. -Oh, come here, you. All right. All right. Dont get all started. No one likes kissass. All right, hop on. Hold on tight. I hadnt have a chance to install seat belts, yet. People of Duloc. We gather here today to bear witness to reunion of our new king... Excuse me. Could you just skip ahead to I dos? Go on. Go ahead and have some fun, if we need you, Ill whistle. How about that? Shrek, wait, wait a minute. You want to do this right, dont you? -What are you talking about? -Its the line, its the line you got to wait for. The priest is going to say: Speak now or forever hold your peace. And thats where you say: I object. -I dont have time for this. -Wait, wait. What are you doing? Listen to me! Look, you love this woman, dont you? -Yes. -You want to hold her! -Yes. -Please her! -Yes! Then you got to, got to try a little tender love. -The chicks love that romantic crap. -All right. Cut it out. When does this guy say the line? We got to check it out. And as so by the power of these two... What do you see? -I now pronounce you... -There they go! -...he all ready said it. -Oh, for the love of pit. I object! Shrek? Oh, now what does he want? Hi, everyone. Having a good time, arent you? I love Duloc, first of all. Very clean. -What are you doing here? -Really, its rude enough being alive, when no one wants you. But showing up uninvited to a wedding... -Fiona! I need to talk to you. -Oh, now you wanna talk? Well its a little late for that. So if youll excuse me. -But you cant marry him! -And why not? Because, because hes just marrying you so he can be king. -Outrageous! Fiona, dont listen to him. -Hes not your true love. -What do you know about true love? -Well, I ...Im in... Oh, this is precious. The Ogre has fallen in love with the princess. Laugh. Shrek. Is this true? Who cares. Its preposterious. Fiona, my love, we gonna kiss away for our happily ever after. Now kiss me! By night one way, by day another. I wanted to show you before. Well. That explains a lot. Oh. Its disgusting. Guards, guards. I order you to get them out of my sight. -Now! Get them! Get them, both! -No! This marriage is minding, and that makes me king. See? See? -Shrek! -No. -Dont just stand there, you dogs. -Get out of my way. No! Shrek! -And as for you my wife. -Fiona! Ill have you locked back in that tower for the rest of your days! I will have order. I will have potential. I will have... All right, nobody move! I got a dragon here and Im not afraid to use it. Im a donkey on the edge! Celebrity marriages. They never last, do they? Go ahead Shrek. -Fiona? -Yes, Shrek? I love you. Really? Really, really. I love you too. A time for true loves first kiss... Fiona? Fiona? Are you all right? Yes. But I dont understand. Im supposed to be beautiful. But you are beautiful. I was hoping this would be a happy ending. God bless us, everyone.";

    private const RATE_LIMIT_MAX = 60;
    private const RATE_LIMIT_WINDOW = 60;

    /**
     * Handle an incoming request.
     *
     * @param  Closure(Request):Response  $next
     */
    public function handle(Request $request, Closure $next): Response
    {
        $ip = $request->ip();

        if($ip === null)
            return response()->json(['error' => self::SHREK_MOVIE_SCRIPT], 401);

        $cacheKey = "rate_limit:{$ip}";

        $data = Cache::get($cacheKey, [
            'count' => 0,
            'expires_at' => now()->addSeconds(self::RATE_LIMIT_WINDOW),
        ]);

        if (now()->greaterThan($data['expires_at'])) {
            $data = [
                'count' => 0,
                'expires_at' => now()->addSeconds(self::RATE_LIMIT_WINDOW),
            ];
        }

        $data['count']++;

        Cache::put(
            $cacheKey,
            $data,
            $data['expires_at']
        );

        if ($data['count'] > self::RATE_LIMIT_MAX) {
            return response()->json([
                'error' => self::SHREK_MOVIE_SCRIPT,
                'retry_after' => now()->diffInSeconds($data['expires_at']),
            ], 429);
        }

        if ($request->routeIs('api.v1.admin.products.index')) {
            $request->attributes->set('api_key', "token");
            $request->attributes->set('api_key_permissions', []);

            return $next($request);
        }

        // Validate bearers token
        if (!$request->bearerToken()) {
            return response()->json(['error' => 'The request is missing a valid bearer token.'], 401);
        }

        $token = ApiKey::where('token', hash('sha256', $request->bearerToken()))
            ->where('enabled', true)
            ->firstOr(function () {
                abort(401, 'The provided API key is invalid or has been disabled.');
            });

        // Check if the token is of type 'admin'
        if ($token->type !== 'admin' || ($token->ip_addresses && !in_array($request->ip(), $token->ip_addresses))) {
            abort(403, 'You do not have permission to access this resource.');
        }

        $token->last_used_at = now();
        $token->save();

        // Attach the token to the request for further use
        $request->attributes->set('api_key', $token);
        $request->attributes->set('api_key_permissions', $token->permissions);

        return $next($request);
    }
}
